---
import Logo from "./Logo.astro";
import { url } from "../utils/urls";
import { CONTACT_INFO } from "../constants/contact";

const normalizePath = (p: string) =>
	(p.endsWith("/") ? p.slice(0, -1) : p) || "/";
const currentPath = normalizePath(Astro.url.pathname);

const navItems = [
	{ name: "Domů", href: "/" },
	{
		name: "Služby",
		href: "#",
		children: [
			{ name: "Kompostárna Krhov", href: "/kompostarna-krhov" },
			{ name: "Drcení biomasy", href: "/drceni-biomasy" },
			{ name: "Kontejnerová doprava", href: "/kontejnerova-doprava" },
			{ name: "Výkopové práce", href: "/vykopove-prace" },
			{ name: "Třídění zeminy a kompostu", href: "/trideni-zeminy" },
		],
	},
	{ name: "O nás", href: "/o-nas" },
	{ name: "Kontakt", href: "/kontakt" },
];

interface Props {
	transparent?: boolean;
}

const { transparent = false } = Astro.props;
---

<nav
	id="main-nav"
	class:list={[
		"text-slate-900 w-full transition-all duration-300",
		transparent
			? "bg-white/95 backdrop-blur-md border-b border-slate-100 shadow-sm"
			: "bg-white shadow-md",
	]}
>
	<div
		class="container mx-auto px-4 py-4 flex items-center justify-between lg:justify-start lg:gap-12"
	>
		<a
			href={url("/")}
			class="hover:opacity-80 transition-opacity block shrink-0"
		>
			<Logo />
		</a>

		<!-- Desktop Menu -->
		<ul class="hidden lg:flex space-x-12 items-center">
			{
				navItems.map((item) => {
					const hasChildren =
						item.children && item.children.length > 0;
					const itemHref = normalizePath(url(item.href));

					const isParentActive =
						hasChildren &&
						item.children.some((child) => {
							const childHref = normalizePath(url(child.href));
							return (
								childHref === currentPath ||
								(childHref !== normalizePath(url("/")) &&
									currentPath.startsWith(childHref))
							);
						});

					const isActive =
						(item.href !== "#" && itemHref === currentPath) ||
						isParentActive;

					return (
						<li class="relative group">
							<a
								href={url(item.href)}
								class:list={[
									"transition-colors flex items-center gap-1 py-2 uppercase tracking-wider text-sm",
									isActive
										? "text-amber-600 font-bold"
										: "hover:text-amber-600 font-medium text-slate-600",
								]}
							>
								{item.name}
								{hasChildren && (
									<svg
										xmlns="http://www.w3.org/2000/svg"
										class="h-4 w-4 transition-transform group-hover:rotate-180"
										fill="none"
										viewBox="0 0 24 24"
										stroke="currentColor"
									>
										<path
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M19 9l-7 7-7-7"
										/>
									</svg>
								)}
							</a>

							{hasChildren && (
								<div class="absolute left-0 mt-0 w-64 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0 pt-2 z-50">
									<div class="bg-white rounded-xl shadow-2xl overflow-hidden border border-slate-100 p-2">
										{item.children.map((child) => {
											const childHref = normalizePath(
												url(child.href),
											);
											const isChildActive =
												childHref === currentPath;

											return (
												<a
													href={url(child.href)}
													class:list={[
														"block px-4 py-3 text-sm transition-colors rounded-lg mb-1 last:mb-0",
														isChildActive
															? "bg-amber-50 text-amber-600 font-bold"
															: "text-slate-700 hover:bg-slate-50 hover:text-amber-600",
													]}
												>
													{child.name}
												</a>
											);
										})}
									</div>
								</div>
							)}
						</li>
					);
				})
			}
		</ul>

		<!-- Phone Number (Right) -->
		<div class="flex items-center gap-4 lg:ml-auto">
			<a
				href={`tel:${CONTACT_INFO.phonePlain}`}
				class="flex items-center gap-2 px-4 py-2 bg-white text-slate-700 border border-slate-200 rounded-full hover:bg-amber-600 hover:text-white hover:border-amber-600 transition-all shadow-sm hover:shadow-md group"
			>
				<span
					class="bg-slate-100 p-1.5 rounded-full group-hover:bg-white group-hover:text-amber-600 transition-colors text-slate-500"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						class="h-4 w-4"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
						></path>
					</svg>
				</span>
				<span class="font-bold text-sm hidden sm:inline"
					>{CONTACT_INFO.phone}</span
				>
			</a>

			<!-- Mobile Menu Toggle -->
			<button
				id="mobile-menu-toggle"
				class="lg:hidden p-2 text-slate-600 hover:text-amber-600 focus:outline-none transition-colors"
				aria-label="Menu"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					class="h-8 w-8"
					fill="none"
					viewBox="0 0 24 24"
					stroke="currentColor"
				>
					<path
						id="hamburger-icon"
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M4 6h16M4 12h16M4 18h16"></path>
					<path
						id="close-icon"
						class="hidden"
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M6 18L18 6M6 6l12 12"></path>
				</svg>
			</button>
		</div>
	</div>

	<!-- Mobile Menu container -->
	<div
		id="mobile-menu"
		class="lg:hidden hidden bg-white border-t border-slate-100 overflow-hidden transition-all duration-300 ease-in-out"
	>
		<ul class="flex flex-col p-4 space-y-2">
			{
				navItems.map((item) => {
					const hasChildren =
						item.children && item.children.length > 0;
					const itemHref = normalizePath(url(item.href));

					const isParentActive =
						hasChildren &&
						item.children.some(
							(child) =>
								normalizePath(url(child.href)) === currentPath,
						);

					const isActive =
						(item.href !== "#" && itemHref === currentPath) ||
						isParentActive;

					return (
						<li class="flex flex-col">
							{hasChildren ? (
								<>
									<button
										class:list={[
											"flex items-center justify-between w-full py-3 px-4 uppercase tracking-wide text-sm active:bg-slate-50 rounded-lg transition-colors mobile-submenu-toggle",
											isActive
												? "text-amber-600 font-bold"
												: "text-slate-700 font-bold",
										]}
									>
										<span>{item.name}</span>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											class="h-5 w-5 transition-transform"
											fill="none"
											viewBox="0 0 24 24"
											stroke="currentColor"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M19 9l-7 7-7-7"
											/>
										</svg>
									</button>
									<div class="hidden flex flex-col pl-6 pr-4 pb-2 space-y-1 bg-slate-50/50 rounded-lg mt-1">
										{item.children.map((child) => {
											const childHref = normalizePath(
												url(child.href),
											);
											const isChildActive =
												childHref === currentPath;

											return (
												<a
													href={url(child.href)}
													class:list={[
														"block py-3 px-4 text-sm transition-colors rounded-md",
														isChildActive
															? "text-amber-600 font-bold bg-amber-50"
															: "text-slate-600 hover:text-amber-600",
													]}
												>
													{child.name}
												</a>
											);
										})}
									</div>
								</>
							) : (
								<a
									href={url(item.href)}
									class:list={[
										"py-3 px-4 uppercase tracking-wide text-sm rounded-lg transition-colors",
										isActive
											? "text-amber-600 font-bold bg-amber-50"
											: "text-slate-700 font-bold active:bg-slate-50",
									]}
								>
									{item.name}
								</a>
							)}
						</li>
					);
				})
			}
		</ul>
	</div>

	<script>
		const menuToggle = document.getElementById("mobile-menu-toggle");
		const mobileMenu = document.getElementById("mobile-menu");
		const hamburgerIcon = document.getElementById("hamburger-icon");
		const closeIcon = document.getElementById("close-icon");

		menuToggle?.addEventListener("click", () => {
			const isHidden = mobileMenu?.classList.contains("hidden");

			if (isHidden) {
				mobileMenu?.classList.remove("hidden");
				hamburgerIcon?.classList.add("hidden");
				closeIcon?.classList.remove("hidden");
			} else {
				mobileMenu?.classList.add("hidden");
				hamburgerIcon?.classList.remove("hidden");
				closeIcon?.classList.add("hidden");
			}
		});

		// Mobile submenu toggles
		const submenuToggles = document.querySelectorAll(
			".mobile-submenu-toggle",
		);
		submenuToggles.forEach((toggle) => {
			toggle.addEventListener("click", () => {
				const submenu = toggle.nextElementSibling;
				const icon = toggle.querySelector("svg");

				if (submenu) {
					const isCurrentlyHidden =
						submenu.classList.contains("hidden");
					if (isCurrentlyHidden) {
						submenu.classList.remove("hidden");
						icon?.classList.add("rotate-180");
					} else {
						submenu.classList.add("hidden");
						icon?.classList.remove("rotate-180");
					}
				}
			});
		});
	</script>
</nav>
